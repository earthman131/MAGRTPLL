function rtpdata=rtp_af(magc,npts,ny,nx,dec,inc,af0)
inc=inc*pi/180;
dec=dec*pi/180;
af0=af0*pi/180;
xdiff=floor((npts-nx)/2); ydiff=floor((npts-ny)/2);
gf=taper2d(magc,npts,ny,nx,ydiff,xdiff);
f=fft2(gf,npts,npts);
fx=f;
L=cos(dec)*cos(inc);
M=sin(dec)*cos(inc);
N=sin(inc);
wn=2.0*pi/(npts-1);
for I=1:npts/2
    for J=1:npts/2
        U=I*wn; V=J*wn;
        a=atan(V/U);
        V1=tan(af0+dec)*U;
        temp=U*U+V1*V1;
        temp1=L*U+M*V1;
        temp2=N*N*temp-temp1*temp1;
        base=temp2*temp2+4.0*N*N*temp1*temp1*temp;
        Rpart01=temp*temp2/base;
        Ipart01=-2.0*N*temp1*(temp^1.5)/base;
        temp1=-L*U+M*V1;
        temp2=N*N*temp-temp1*temp1;
        base=temp2*temp2+4.0*N*N*temp1*temp1*temp;
        Rpart02=temp*temp2/base;
        Ipart02=-2.0*N*temp1*(temp^1.5)/base;
        temp1=L*U-M*V1;
        temp2=N*N*temp-temp1*temp1;
        base=temp2*temp2+4.0*N*N*temp1*temp1*temp;
        Rpart03=temp*temp2/base;
        Ipart03=-2.0*N*temp1*(temp^1.5)/base;
        temp1=-L*U-M*V1;
        temp2=N*N*temp-temp1*temp1;
        base=temp2*temp2+4.0*N*N*temp1*temp1*temp;
        Rpart04=temp*temp2/base;
        Ipart04=-2.0*N*temp1*(temp^1.5)/base;
        if abs(dec-a)<=af0
            temp=U*U+V*V;
            temp1=L*U+M*V;
            temp2=N*N*temp-temp1*temp1;
            base=temp2*temp2+4.0*N*N*temp1*temp1*temp;
            Rpart=temp*temp2/base;
            Ipart=-2.0*N*temp1*(temp^1.5)/base;
        elseif (a>dec+af0)&&(a<=dec+pi/2)
            V2=tan(2*(dec+af0)-a)*U;
            temp=U*U+V2*V2;
            temp1=L*U+M*V2;
            temp2=N*N*temp-temp1*temp1;
            base=temp2*temp2+4.0*N*N*temp1*temp1*temp;
            Rpart=2*Rpart01-temp*temp2/base;
            Ipart=2*Ipart01+2.0*N*temp1*(temp^1.5)/base;
        else
            V2=tan(2*(dec-af0)-a)*U;
            temp=U*U+V2*V2;
            temp1=L*U+M*V2;
            temp2=N*N*temp-temp1*temp1;
            base=temp2*temp2+4.0*N*N*temp1*temp1*temp;
            Rpart=2*Rpart01-temp*temp2/base;
            Ipart=2*Ipart01+2.0*N*temp1*(temp^1.5)/base;
        end
        temp3=real(f(I,J));
        temp4=imag(f(I,J));
        fx(I,J)=real(Rpart*temp3-temp4*Ipart)+1i*real(Rpart*temp4+Ipart*temp3);
        if abs(dec-a)<=af0
            temp=U*U+V*V;
            temp1=-L*U+M*V;
            temp2=N*N*temp-temp1*temp1;
            base=temp2*temp2+4.0*N*N*temp1*temp1*temp;
            Rpart=temp*temp2/base;
            Ipart=-2.0*N*temp1*(temp^1.5)/base;
        elseif (a>dec+af0)&&(a<=dec+pi/2)
            V2=tan(2*(dec+af0)-a)*U;
            temp=U*U+V2*V2;
            temp1=-L*U+M*V2;
            temp2=N*N*temp-temp1*temp1;
            base=temp2*temp2+4.0*N*N*temp1*temp1*temp;
            Rpart=2*Rpart02-temp*temp2/base;
            Ipart=2*Ipart02+2.0*N*temp1*(temp^1.5)/base;
        else
            V2=tan(2*(dec-af0)-a)*U;
            temp=U*U+V2*V2;
            temp1=-L*U+M*V2;
            temp2=N*N*temp-temp1*temp1;
            base=temp2*temp2+4.0*N*N*temp1*temp1*temp;
            Rpart=2*Rpart02-temp*temp2/base;
            Ipart=2*Ipart02+2.0*N*temp1*(temp^1.5)/base;
        end
        temp3=real(f(npts-I+1,J));
        temp4=imag(f(npts-I+1,J));
        fx(npts-I+1,J)=real(Rpart*temp3-temp4*Ipart)+1i*real(Rpart*temp4+Ipart*temp3);
        if abs(dec-a)<=af0
            temp=U*U+V*V;
            temp1=L*U-M*V;
            temp2=N*N*temp-temp1*temp1;
            base=temp2*temp2+4.0*N*N*temp1*temp1*temp;
            Rpart=temp*temp2/base;
            Ipart=-2.0*N*temp1*(temp^1.5)/base;
        elseif (a>dec+af0)&&(a<=dec+pi/2)
            V2=tan(2*(dec+af0)-a)*U;
            temp=U*U+V2*V2;
            temp1=L*U-M*V2;
            temp2=N*N*temp-temp1*temp1;
            base=temp2*temp2+4.0*N*N*temp1*temp1*temp;
            Rpart=2*Rpart03-temp*temp2/base;
            Ipart=2*Ipart03+2.0*N*temp1*(temp^1.5)/base;
        else
            V2=tan(2*(dec-af0)-a)*U;
            temp=U*U+V2*V2;
            temp1=L*U-M*V2;
            temp2=N*N*temp-temp1*temp1;
            base=temp2*temp2+4.0*N*N*temp1*temp1*temp;
            Rpart=2*Rpart03-temp*temp2/base;
            Ipart=2*Ipart03+2.0*N*temp1*(temp^1.5)/base;
        end
        temp3=real(f(I,npts-J+1));
        temp4=imag(f(I,npts-J+1));
        fx(I,npts-J+1)=real(Rpart*temp3-temp4*Ipart)+1i*real(Rpart*temp4+Ipart*temp3);
        if abs(dec-a)<=af0
            temp=U*U+V*V;
            temp1=-L*U-M*V;
            temp2=N*N*temp-temp1*temp1;
            base=temp2*temp2+4.0*N*N*temp1*temp1*temp;
            Rpart=temp*temp2/base;
            Ipart=-2.0*N*temp1*(temp^1.5)/base;
        elseif (a>dec+af0)&&(a<=dec+pi/2)
            V2=tan(2*(dec+af0)-a)*U;
            temp=U*U+V2*V2;
            temp1=-L*U-M*V2;
            temp2=N*N*temp-temp1*temp1;
            base=temp2*temp2+4.0*N*N*temp1*temp1*temp;
            Rpart=2*Rpart04-temp*temp2/base;
            Ipart=2*Ipart04+2.0*N*temp1*(temp^1.5)/base;
        else
            V2=tan(2*(dec-af0)-a)*U;
            temp=U*U+V2*V2;
            temp1=-L*U-M*V2;
            temp2=N*N*temp-temp1*temp1;
            base=temp2*temp2+4.0*N*N*temp1*temp1*temp;
            Rpart=2*Rpart04-temp*temp2/base;
            Ipart=2*Ipart04+2.0*N*temp1*(temp^1.5)/base;
        end
        temp3=real(f(npts-I+1,npts-J+1));
        temp4=imag(f(npts-I+1,npts-J+1));
        fx(npts-I+1,npts-J+1)=real(Rpart*temp3-temp4*Ipart)+1i*real(Rpart*temp4+Ipart*temp3);
    end
end
fxinv=ifft2(fx); rtpdata=real(fxinv(1+ydiff:ny+ydiff,1+xdiff:nx+xdiff));